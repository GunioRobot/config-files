#! /usr/local/bin/perl58 -w

use strict;
use File::Copy;

die file_links();
link_files();

sub get_timestamp {
   my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);
   if ($mon < 10) { $mon = "0$mon"; }
   if ($hour < 10) { $hour = "0$hour"; }
   if ($min < 10) { $min = "0$min"; }
   if ($sec < 10) { $sec = "0$sec"; }
   $year=$year+1900;

   return $year . $mon . $mday . '_' . $hour . '_' . $min;
}

sub file_names
{
    my @names = qw/
        bash_aliases
        bash_profile
        bashrc
        dir_colors
        vim
        vimrc
        vimrc_files
    /;
    return @names;
}

sub file_links
{
    return map {glob("~/.$_") => glob("~/config-files/.$_")} file_names();
}

sub link_files
{
    my %file_links = file_links();
    my $backup_date = get_timestamp();

    for my $file (keys %file_links) {
        if (-l $file) {
            unlink $file;
        } elsif (-e $file) {
            move($file, "${file}.${backup_date}");
        }
        my $symlink_exists = eval { symlink($file_links{$file}, $file); 1 };
        die "Symlinking no workie" unless $symlink_exists;
    }

    print "Linking Complete\n";
    my @file_names = file_names();
    print "@file_names\n";
}
